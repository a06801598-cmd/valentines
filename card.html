<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Portrait</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      font-family: 'Courier New', monospace;
      color: #fff;
      padding: 20px;
    }

    h1 {
      font-size: 1.2rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: #aaa;
      margin-bottom: 20px;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      align-items: center;
      justify-content: center;
    }

    input[type="file"] {
      display: none;
    }

    label.btn, button.btn {
      background: #1a1a1a;
      border: 1px solid #444;
      color: #eee;
      padding: 8px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      transition: background 0.2s;
    }

    label.btn:hover, button.btn:hover {
      background: #2a2a2a;
    }

    textarea#lyrics {
      width: 320px;
      height: 60px;
      background: #111;
      border: 1px solid #333;
      color: #ccc;
      font-size: 0.7rem;
      padding: 8px;
      border-radius: 4px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }

    #canvas-container {
      position: relative;
      display: inline-block;
    }

    canvas#imageCanvas {
      display: none;
    }

    pre#portrait {
      font-family: 'Courier New', monospace;
      font-size: 6px;
      line-height: 1.1;
      letter-spacing: 0.05em;
      color: #ffffff;
      background: #000;
      padding: 10px;
      border-radius: 4px;
      white-space: pre;
      display: block;
      max-width: 95vw;
      overflow: hidden;
    }

    #placeholder {
      width: 500px;
      max-width: 90vw;
      height: 300px;
      background: #111;
      border: 2px dashed #333;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #555;
      font-size: 0.9rem;
      gap: 10px;
    }

    #placeholder svg {
      opacity: 0.4;
    }

    #slider-row {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: #888;
    }

    input[type="range"] {
      width: 100px;
      accent-color: #888;
    }
  </style>
</head>
<body>

<h1>âœ¦ Text Portrait Generator âœ¦</h1>

<div id="controls">
  <label class="btn" for="imageInput">ðŸ“· Upload Image</label>
  <input type="file" id="imageInput" accept="image/*">
  <button class="btn" id="generateBtn">âš¡ Generate Portrait</button>
  <button class="btn" id="downloadBtn">ðŸ’¾ Save as PNG</button>
</div>

<div id="slider-row">
  <div class="slider-group">
    <label>Width (chars): <span id="widthVal">120</span></label>
    <input type="range" id="widthSlider" min="40" max="200" value="120">
  </div>
  <div class="slider-group">
    <label>Contrast: <span id="contrastVal">1.2</span></label>
    <input type="range" id="contrastSlider" min="0.5" max="3" step="0.1" value="1.2">
  </div>
  <div class="slider-group">
    <label>Brightness: <span id="brightnessVal">1.0</span></label>
    <input type="range" id="brightnessSlider" min="0.3" max="2" step="0.1" value="1.0">
  </div>
</div>

<br>

<div style="margin-bottom:10px; display:flex; flex-direction:column; align-items:center; gap:4px;">
  <label style="font-size:0.8rem; color:#888;">Song Lyrics (will repeat to fill the portrait):</label>
  <textarea id="lyrics">Lights go down, and the night is calling to me, yeah I hear voices singing songs in the street And I know that we won't be going home for so long, for so long But I know that I won't be on my own, yeah I love this feeling and Right now I wish you were here with me (Oh-ooh) 'Cause right now Everything is new to me (Oh-ooh) You know I can't fight the feeling And every night I feel it Right now I wish you were here with me (Oh-ooh) Late night spaces With all our friends, you and me, yeah Love these faces Just like how it used to be And we won't be going home For so long, for so long But I know, I won't be on my own On my own, I'm feeling like Right now I wish you were here with me (Oh-ooh) 'Cause right now Everything is new to me (Oh-ooh) You know I can't fight the feeling And every night I feel it Right now I wish you were here with me (Oh-ooh) And I could do this forever (Woah-oh-oh, woah-oh-oh) And let's go crazy together (Woah-oh-oh, woah-oh-oh) Lights go down, and</textarea>
</div>

<canvas id="imageCanvas"></canvas>

<div id="portraitContainer">
  <div id="placeholder">
    <svg width="48" height="48" viewbox="0 0 24 24" fill="none" stroke="#888" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2" /><circle cx="8.5" cy="8.5" r="1.5" />
      <polyline points="21 15 16 10 5 21" />
    </svg>
    <span>Upload an image and click Generate Portrait</span>
    <span style="font-size:0.75rem; color:#444;">Works best with high-contrast face photos</span>
  </div>
</div>

<canvas id="downloadCanvas" style="display:none;"></canvas>

<script>
  let uploadedImage = null;

  const widthSlider = document.getElementById('widthSlider');
  const contrastSlider = document.getElementById('contrastSlider');
  const brightnessSlider = document.getElementById('brightnessSlider');
  widthSlider.addEventListener('input', () => document.getElementById('widthVal').textContent = widthSlider.value);
  contrastSlider.addEventListener('input', () => document.getElementById('contrastVal').textContent = parseFloat(contrastSlider.value).toFixed(1));
  brightnessSlider.addEventListener('input', () => document.getElementById('brightnessVal').textContent = parseFloat(brightnessSlider.value).toFixed(1));

  document.getElementById('imageInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => { uploadedImage = img; };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('generateBtn').addEventListener('click', generatePortrait);

  function generatePortrait() {
    if (!uploadedImage) {
      alert('Please upload an image first!');
      return;
    }

    const lyrics = document.getElementById('lyrics').value.trim() || 'Text Portrait ';
    const cols = parseInt(widthSlider.value);
    const contrastFactor = parseFloat(contrastSlider.value);
    const brightnessFactor = parseFloat(brightnessSlider.value);

    // Use 2:1 ratio (chars are taller than wide)
    const charAspect = 0.55;
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');

    // Scale image to desired cols
    const scale = cols / uploadedImage.width;
    const rows = Math.floor(uploadedImage.height * scale * charAspect);
    canvas.width = cols;
    canvas.height = rows;

    ctx.drawImage(uploadedImage, 0, 0, cols, rows);
    const imageData = ctx.getImageData(0, 0, cols, rows);
    const data = imageData.data;

    let lyricsIndex = 0;
    let result = '';

    for (let y = 0; y < rows; y++) {
      for (let x = 0; x < cols; x++) {
        const idx = (y * cols + x) * 4;
        let r = data[idx], g = data[idx+1], b = data[idx+2];

        // Grayscale
        let gray = 0.299*r + 0.587*g + 0.114*b;

        // Brightness
        gray = gray * brightnessFactor;

        // Contrast: pivot at 128
        gray = (gray - 128) * contrastFactor + 128;
        gray = Math.max(0, Math.min(255, gray));

        // Threshold: dark pixels get a lyric char, light pixels get a space
        const threshold = 128;
        if (gray < threshold) {
          // Pick next char from lyrics (skip spaces for denser look)
          let ch = lyrics[lyricsIndex % lyrics.length];
          lyricsIndex++;
          // skip whitespace chars in lyrics to keep density
          while (ch === '\n' || ch === '\r') {
            lyricsIndex++;
            ch = lyrics[lyricsIndex % lyrics.length];
          }
          result += ch;
        } else {
          result += ' ';
        }
      }
      result += '\n';
    }

    const portraitEl = document.createElement('pre');
    portraitEl.id = 'portrait';
    portraitEl.textContent = result;

    const container = document.getElementById('portraitContainer');
    container.innerHTML = '';
    container.appendChild(portraitEl);
  }

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const pre = document.getElementById('portrait');
    if (!pre) { alert('Generate a portrait first!'); return; }

    const lines = pre.textContent.split('\n');
    const fontSize = 7;
    const lineHeight = Math.floor(fontSize * 1.1);
    const charWidth = fontSize * 0.6;
    const padding = 20;

    const maxCols = Math.max(...lines.map(l => l.length));
    const w = Math.ceil(maxCols * charWidth) + padding * 2;
    const h = lines.length * lineHeight + padding * 2;

    const dc = document.getElementById('downloadCanvas');
    dc.width = w;
    dc.height = h;
    const dctx = dc.getContext('2d');
    dctx.fillStyle = '#000';
    dctx.fillRect(0, 0, w, h);
    dctx.fillStyle = '#fff';
    dctx.font = `${fontSize}px "Courier New", monospace`;

    lines.forEach((line, i) => {
      dctx.fillText(line, padding, padding + (i+1) * lineHeight);
    });

    const a = document.createElement('a');
    a.download = 'text_portrait.png';
    a.href = dc.toDataURL('image/png');
    a.click();
  });
</script>

</body></html>
